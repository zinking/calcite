# match.iq - MATCH_RECOGNIZE clause
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
!use post
!set outputformat mysql

!use scott
# Match recognize - detecting v shape in trend
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  STRT.tstamp AS start_tstamp,
               LAST(DOWN.tstamp) AS bottom_tstamp,
               LAST(UP.tstamp) AS end_tstamp
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST UP
     PATTERN (STRT DOWN+ UP+)
     DEFINE
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.start_tstamp;
+--------+--------------+---------------+------------+
| SYMBOL | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP |
+--------+--------------+---------------+------------+
| ACME   | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |
| ACME   | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |
| ACME   | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |
+--------+--------------+---------------+------------+
(3 rows)

!ok

# match recognize - detecting v shape without 'after match skip to last up'
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  STRT.tstamp AS start_tstamp,
               LAST(DOWN.tstamp) AS bottom_tstamp,
               LAST(UP.tstamp) AS end_tstamp
     ONE ROW PER MATCH
     PATTERN (STRT DOWN+ UP+)
     DEFINE
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.start_tstamp;

+--------+--------------+---------------+------------+
| SYMBOL | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP |
+--------+--------------+---------------+------------+
| ACME   | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |
| ACME   | 11-DEC-17    | 12-DEC-17     | 13-DEC-17  |
| ACME   | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |
+--------+--------------+---------------+------------+
(3 rows)

!ok

# match recognize - detecting v and the point before v
# still missing one such pattern
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  PRESTRT.tstamp as prestart_tstamp,
               STRT.tstamp AS start_tstamp,
               LAST(DOWN.tstamp) AS bottom_tstamp,
               LAST(UP.tstamp) AS end_tstamp
     ONE ROW PER MATCH
     -- AFTER MATCH SKIP TO LAST UP
     PATTERN (PRESTRT STRT DOWN+ UP+)
     DEFINE
        STRT AS STRT.tstamp > PRESTRT.tstamp,
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.start_tstamp;

+--------+-----------------+--------------+---------------+------------+
| SYMBOL | PRESTART_TSTAMP | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP |
+--------+-----------------+--------------+---------------+------------+
| ACME   | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |
| ACME   | 13-DEC-17       | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |
+--------+-----------------+--------------+---------------+------------+
(2 rows)

!ok

# match recognize - detecting v and the point before v
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  PRESTRT.tstamp as prestart_tstamp,
               STRT.tstamp AS start_tstamp,
               LAST(DOWN.tstamp) AS bottom_tstamp,
               LAST(UP.tstamp) AS end_tstamp
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST DOWN
     PATTERN (PRESTRT STRT DOWN+ UP+)
     DEFINE
        STRT AS STRT.tstamp > PRESTRT.tstamp,
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.start_tstamp;

+--------+-----------------+--------------+---------------+------------+
| SYMBOL | PRESTART_TSTAMP | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP |
+--------+-----------------+--------------+---------------+------------+
| ACME   | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |
| ACME   | 09-DEC-17       | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |
| ACME   | 13-DEC-17       | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |
+--------+-----------------+--------------+---------------+------------+
(3 rows)

!ok

# match recognize
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  STRT.tstamp AS start_tstamp,
               FINAL LAST(DOWN.tstamp) AS bottom_tstamp,
               FINAL LAST(UP.tstamp) AS end_tstamp,
               MATCH_NUMBER() AS match_num,
               CLASSIFIER() AS var_match
     ALL ROWS PER MATCH
     AFTER MATCH SKIP TO LAST UP
     PATTERN (STRT DOWN+ UP+)
     DEFINE
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.match_num, MR.tstamp;
+--------+-----------+--------------+---------------+------------+-----------+-----------+-------+
| SYMBOL |  TSTAMP   | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP | MATCH_NUM | VAR_MATCH | PRICE |
+--------+-----------+--------------+---------------+------------+-----------+-----------+-------+
| ACME   | 05-DEC-17 | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | STRT      |    25 |
| ACME   | 06-DEC-17 | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | DOWN      |    12 |
| ACME   | 07-DEC-17 | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | UP        |    15 |
| ACME   | 08-DEC-17 | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | UP        |    20 |
| ACME   | 09-DEC-17 | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | UP        |    24 |
| ACME   | 10-DEC-17 | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | UP        |    25 |
| ACME   | 10-DEC-17 | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |         2 | STRT      |    25 |
| ACME   | 11-DEC-17 | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |         2 | DOWN      |    19 |
| ACME   | 12-DEC-17 | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |         2 | DOWN      |    15 |
| ACME   | 13-DEC-17 | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |         2 | UP        |    25 |
| ACME   | 14-DEC-17 | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |         3 | STRT      |    25 |
| ACME   | 15-DEC-17 | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |         3 | DOWN      |    14 |
| ACME   | 16-DEC-17 | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |         3 | DOWN      |    12 |
| ACME   | 17-DEC-17 | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |         3 | UP        |    14 |
| ACME   | 18-DEC-17 | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |         3 | UP        |    24 |
+--------+-----------+--------------+---------------+------------+-----------+-----------+-------+
(15 rows)

!ok

#match recognize - finding the -v parttern full list
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  PRESTRT.tstamp as prestart_tstamp,
               STRT.tstamp AS start_tstamp,
               LAST(DOWN.tstamp) AS bottom_tstamp,
               LAST(UP.tstamp) AS end_tstamp,
               MATCH_NUMBER() AS match_num,
               CLASSIFIER() AS var_match
     ALL ROWS PER MATCH
     AFTER MATCH SKIP TO LAST DOWN
     PATTERN (PRESTRT STRT DOWN+ UP+)
     DEFINE
        STRT AS STRT.tstamp > PRESTRT.tstamp,
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.match_num, MR.tstamp;
+--------+-----------+-----------------+--------------+---------------+------------+-----------+-----------+-------+
| SYMBOL |  TSTAMP   | PRESTART_TSTAMP | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP | MATCH_NUM | VAR_MATCH | PRICE |
+--------+-----------+-----------------+--------------+---------------+------------+-----------+-----------+-------+
| ACME   | 04-DEC-17 | 04-DEC-17       |  -           |  -            |  -         |         1 | PRESTRT   |    21 |
| ACME   | 05-DEC-17 | 04-DEC-17       | 05-DEC-17    |  -            |  -         |         1 | STRT      |    25 |
| ACME   | 06-DEC-17 | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     |  -         |         1 | DOWN      |    12 |
| ACME   | 07-DEC-17 | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     | 07-DEC-17  |         1 | UP        |    15 |
| ACME   | 08-DEC-17 | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     | 08-DEC-17  |         1 | UP        |    20 |
| ACME   | 09-DEC-17 | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     | 09-DEC-17  |         1 | UP        |    24 |
| ACME   | 10-DEC-17 | 04-DEC-17       | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |         1 | UP        |    25 |
| ACME   | 09-DEC-17 | 09-DEC-17       |  -           |  -            |  -         |         2 | PRESTRT   |    24 |
| ACME   | 10-DEC-17 | 09-DEC-17       | 10-DEC-17    |  -            |  -         |         2 | STRT      |    25 |
| ACME   | 11-DEC-17 | 09-DEC-17       | 10-DEC-17    | 11-DEC-17     |  -         |         2 | DOWN      |    19 |
| ACME   | 12-DEC-17 | 09-DEC-17       | 10-DEC-17    | 12-DEC-17     |  -         |         2 | DOWN      |    15 |
| ACME   | 13-DEC-17 | 09-DEC-17       | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |         2 | UP        |    25 |
| ACME   | 13-DEC-17 | 13-DEC-17       |  -           |  -            |  -         |         3 | PRESTRT   |    25 |
| ACME   | 14-DEC-17 | 13-DEC-17       | 14-DEC-17    |  -            |  -         |         3 | STRT      |    25 |
| ACME   | 15-DEC-17 | 13-DEC-17       | 14-DEC-17    | 15-DEC-17     |  -         |         3 | DOWN      |    14 |
| ACME   | 16-DEC-17 | 13-DEC-17       | 14-DEC-17    | 16-DEC-17     |  -         |         3 | DOWN      |    12 |
| ACME   | 17-DEC-17 | 13-DEC-17       | 14-DEC-17    | 16-DEC-17     | 17-DEC-17  |         3 | UP        |    14 |
| ACME   | 18-DEC-17 | 13-DEC-17       | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |         3 | UP        |    24 |
+--------+-----------+-----------------+--------------+---------------+------------+-----------+-----------+-------+
(18 rows)

!ok

#match recognize - difference between final / non final
SELECT *
FROM Ticker t
MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES
              MATCH_NUMBER() AS match_num,
              CLASSIFIER() AS var_match,
              STRT.tstamp AS start_tstamp,
              LAST(DOWN.tstamp) AS bottom_tstamp,
              LAST(UP.tstamp) AS end_tstamp,
              min(DOWN.price) as current_min_price,
              final min(DOWN.price) as final_min_price
     ALL ROWS PER MATCH
     AFTER MATCH SKIP TO LAST UP
     PATTERN (STRT DOWN+ UP+)
     DEFINE
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.match_num, MR.tstamp;
+--------+-----------+-----------+-----------+--------------+---------------+------------+-------------------+-----------------+-------+
| SYMBOL |  TSTAMP   | MATCH_NUM | VAR_MATCH | START_TSTAMP | BOTTOM_TSTAMP | END_TSTAMP | CURRENT_MIN_PRICE | FINAL_MIN_PRICE | PRICE |
+--------+-----------+-----------+-----------+--------------+---------------+------------+-------------------+-----------------+-------+
| ACME   | 05-DEC-17 |         1 | STRT      | 05-DEC-17    |  -            |  -         |                -  |              12 |    25 |
| ACME   | 06-DEC-17 |         1 | DOWN      | 05-DEC-17    | 06-DEC-17     |  -         |                12 |              12 |    12 |
| ACME   | 07-DEC-17 |         1 | UP        | 05-DEC-17    | 06-DEC-17     | 07-DEC-17  |                12 |              12 |    15 |
| ACME   | 08-DEC-17 |         1 | UP        | 05-DEC-17    | 06-DEC-17     | 08-DEC-17  |                12 |              12 |    20 |
| ACME   | 09-DEC-17 |         1 | UP        | 05-DEC-17    | 06-DEC-17     | 09-DEC-17  |                12 |              12 |    24 |
| ACME   | 10-DEC-17 |         1 | UP        | 05-DEC-17    | 06-DEC-17     | 10-DEC-17  |                12 |              12 |    25 |
| ACME   | 10-DEC-17 |         2 | STRT      | 10-DEC-17    |  -            |  -         |                -  |              15 |    25 |
| ACME   | 11-DEC-17 |         2 | DOWN      | 10-DEC-17    | 11-DEC-17     |  -         |                19 |              15 |    19 |
| ACME   | 12-DEC-17 |         2 | DOWN      | 10-DEC-17    | 12-DEC-17     |  -         |                15 |              15 |    15 |
| ACME   | 13-DEC-17 |         2 | UP        | 10-DEC-17    | 12-DEC-17     | 13-DEC-17  |                15 |              15 |    25 |
| ACME   | 14-DEC-17 |         3 | STRT      | 14-DEC-17    |  -            |  -         |                -  |              12 |    25 |
| ACME   | 15-DEC-17 |         3 | DOWN      | 14-DEC-17    | 15-DEC-17     |  -         |                14 |              12 |    14 |
| ACME   | 16-DEC-17 |         3 | DOWN      | 14-DEC-17    | 16-DEC-17     |  -         |                12 |              12 |    12 |
| ACME   | 17-DEC-17 |         3 | UP        | 14-DEC-17    | 16-DEC-17     | 17-DEC-17  |                12 |              12 |    14 |
| ACME   | 18-DEC-17 |         3 | UP        | 14-DEC-17    | 16-DEC-17     | 18-DEC-17  |                12 |              12 |    24 |
+--------+-----------+-----------+-----------+--------------+---------------+------------+-------------------+-----------------+-------+
(15 rows)

!ok

#match recognize
SELECT *
FROM Ticker MATCH_RECOGNIZE (
  PARTITION BY symbol
  ORDER BY tstamp
  MEASURES
    MATCH_NUMBER() AS match_num,
    CLASSIFIER() AS var_match,
    FINAL COUNT(UP.tstamp) AS up_days,
    FINAL COUNT(tstamp) AS total_days,
    RUNNING COUNT(tstamp) AS cnt_days,
    price - STRT.price AS price_dif
  ALL ROWS PER MATCH
  AFTER MATCH SKIP TO LAST UP
  PATTERN (STRT DOWN+ UP+)
  DEFINE
    DOWN AS DOWN.price < PREV(DOWN.price),
    UP AS UP.price > PREV(UP.price)
  ) MR
ORDER BY MR.symbol, MR.match_num, MR.tstamp;
+--------+-----------+-----------+-----------+---------+------------+----------+-----------+-------+
| SYMBOL |  TSTAMP   | MATCH_NUM | VAR_MATCH | UP_DAYS | TOTAL_DAYS | CNT_DAYS | PRICE_DIF | PRICE |
+--------+-----------+-----------+-----------+---------+------------+----------+-----------+-------+
| ACME   | 05-DEC-17 |         1 | STRT      |       4 |          6 |        1 |         0 |    25 |
| ACME   | 06-DEC-17 |         1 | DOWN      |       4 |          6 |        2 |       -13 |    12 |
| ACME   | 07-DEC-17 |         1 | UP        |       4 |          6 |        3 |       -10 |    15 |
| ACME   | 08-DEC-17 |         1 | UP        |       4 |          6 |        4 |        -5 |    20 |
| ACME   | 09-DEC-17 |         1 | UP        |       4 |          6 |        5 |        -1 |    24 |
| ACME   | 10-DEC-17 |         1 | UP        |       4 |          6 |        6 |         0 |    25 |
| ACME   | 10-DEC-17 |         2 | STRT      |       1 |          4 |        1 |         0 |    25 |
| ACME   | 11-DEC-17 |         2 | DOWN      |       1 |          4 |        2 |        -6 |    19 |
| ACME   | 12-DEC-17 |         2 | DOWN      |       1 |          4 |        3 |       -10 |    15 |
| ACME   | 13-DEC-17 |         2 | UP        |       1 |          4 |        4 |         0 |    25 |
| ACME   | 14-DEC-17 |         3 | STRT      |       2 |          5 |        1 |         0 |    25 |
| ACME   | 15-DEC-17 |         3 | DOWN      |       2 |          5 |        2 |       -11 |    14 |
| ACME   | 16-DEC-17 |         3 | DOWN      |       2 |          5 |        3 |       -13 |    12 |
| ACME   | 17-DEC-17 |         3 | UP        |       2 |          5 |        4 |       -11 |    14 |
| ACME   | 18-DEC-17 |         3 | UP        |       2 |          5 |        5 |        -1 |    24 |
+--------+-----------+-----------+-----------+---------+------------+----------+-----------+-------+
(15 rows)

!ok

#match recognize
SELECT *
FROM Ticker MATCH_RECOGNIZE (
  PARTITION BY symbol
  ORDER BY tstamp
  MEASURES
    MATCH_NUMBER() AS match_num,
    CLASSIFIER()  AS  var_match,
    STRT.tstamp AS start_tstamp,
    FINAL LAST(UP.tstamp) AS end_tstamp
  ALL ROWS PER MATCH
  AFTER MATCH SKIP TO LAST UP
  PATTERN (STRT DOWN+ UP+ DOWN+ UP+)
  DEFINE
    DOWN AS DOWN.price < PREV(DOWN.price),
    UP AS UP.price > PREV(UP.price)
  ) MR
ORDER BY MR.symbol, MR.match_num, MR.tstamp;
+--------+-----------+-----------+-----------+--------------+------------+-------+
| SYMBOL |  TSTAMP   | MATCH_NUM | VAR_MATCH | START_TSTAMP | END_TSTAMP | PRICE |
+--------+-----------+-----------+-----------+--------------+------------+-------+
| ACME   | 05-DEC-17 |         1 | STRT      | 05-DEC-17    | 13-DEC-17  |    25 |
| ACME   | 06-DEC-17 |         1 | DOWN      | 05-DEC-17    | 13-DEC-17  |    12 |
| ACME   | 07-DEC-17 |         1 | UP        | 05-DEC-17    | 13-DEC-17  |    15 |
| ACME   | 08-DEC-17 |         1 | UP        | 05-DEC-17    | 13-DEC-17  |    20 |
| ACME   | 09-DEC-17 |         1 | UP        | 05-DEC-17    | 13-DEC-17  |    24 |
| ACME   | 10-DEC-17 |         1 | UP        | 05-DEC-17    | 13-DEC-17  |    25 |
| ACME   | 11-DEC-17 |         1 | DOWN      | 05-DEC-17    | 13-DEC-17  |    19 |
| ACME   | 12-DEC-17 |         1 | DOWN      | 05-DEC-17    | 13-DEC-17  |    15 |
| ACME   | 13-DEC-17 |         1 | UP        | 05-DEC-17    | 13-DEC-17  |    25 |
+--------+-----------+-----------+-----------+--------------+------------+-------+
(9 rows)

!ok

#match recognize
SELECT *
FROM Ticker MATCH_RECOGNIZE(
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES FIRST(STRT.tstamp) AS strt_time,
              LAST(DOWN.tstamp) AS bottom,
              AVG(STDN.Price) AS stdn_avgprice
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST UP
     PATTERN (STRT DOWN+ UP+)
     SUBSET STDN= (STRT, DOWN)
     DEFINE
        UP AS UP.Price > PREV(UP.Price),
        DOWN AS DOWN.Price < PREV (DOWN.Price)
);
+--------+-----------+-----------+-------------------------------------------+
| SYMBOL | STRT_TIME |  BOTTOM   |               STDN_AVGPRICE               |
+--------+-----------+-----------+-------------------------------------------+
| ACME   | 05-DEC-17 | 06-DEC-17 |                                      18.5 |
| ACME   | 10-DEC-17 | 12-DEC-17 | 19.66666666666666666666666666666666666667 |
| ACME   | 14-DEC-17 | 16-DEC-17 |                                        17 |
+--------+-----------+-----------+-------------------------------------------+
(3 rows)

!ok

#match recognize - none measures defined
SELECT *
FROM Ticker MATCH_RECOGNIZE(
     PARTITION BY symbol
     ORDER BY tstamp
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST UP
     PATTERN (STRT DOWN+ UP+)
     SUBSET STDN= (STRT, DOWN)
     DEFINE
        UP AS UP.Price > PREV(UP.Price),
        DOWN AS DOWN.Price < PREV (DOWN.Price)
);
+--------+
| SYMBOL |
+--------+
| ACME   |
| ACME   |
| ACME   |
+--------+
(3 rows)

!ok

#match recognize - more regular expression match specs
SELECT MR_EW.*
FROM ticker MATCH_RECOGNIZE (
     PARTITION by symbol
     ORDER by tstamp
     MEASURES V.tstamp AS START_T,
              Z.tstamp AS END_T,
              COUNT(V.price) AS CNT_V,
              COUNT(W.price) AS UP__W,
              COUNT(X.price) AS DWN_X,
              COUNT(Y.price) AS UP__Y,
              COUNT(Z.price) AS DWN_Z,
    MATCH_NUMBER() AS MNO
    ALL ROWS PER MATCH
    AFTER MATCH SKIP TO LAST Z
    PATTERN (V W{1,2} X{0,1} Y{0,1} Z{1,2})
    DEFINE
       W AS W.price > PREV(W.price),
       X AS X.price < PREV(X.price),
       Y AS Y.price > PREV(Y.price),
       Z AS Z.price < PREV(Z.price)
) MR_EW
ORDER BY symbol, tstamp;
+--------+-----------+-----------+-----------+-------+-------+-------+-------+-------+-----+-------+
| SYMBOL |  TSTAMP   |  START_T  |   END_T   | CNT_V | UP__W | DWN_X | UP__Y | DWN_Z | MNO | PRICE |
+--------+-----------+-----------+-----------+-------+-------+-------+-------+-------+-----+-------+
| ACME   | 02-DEC-17 | 02-DEC-17 |  -        |     1 |     0 |     0 |     0 |     0 |   1 |    17 |
| ACME   | 03-DEC-17 | 02-DEC-17 |  -        |     1 |     1 |     0 |     0 |     0 |   1 |    19 |
| ACME   | 04-DEC-17 | 02-DEC-17 |  -        |     1 |     2 |     0 |     0 |     0 |   1 |    21 |
| ACME   | 05-DEC-17 | 02-DEC-17 |  -        |     1 |     2 |     0 |     1 |     0 |   1 |    25 |
| ACME   | 06-DEC-17 | 02-DEC-17 | 06-DEC-17 |     1 |     2 |     0 |     1 |     1 |   1 |    12 |
| ACME   | 07-DEC-17 | 07-DEC-17 |  -        |     1 |     0 |     0 |     0 |     0 |   2 |    15 |
| ACME   | 08-DEC-17 | 07-DEC-17 |  -        |     1 |     1 |     0 |     0 |     0 |   2 |    20 |
| ACME   | 09-DEC-17 | 07-DEC-17 |  -        |     1 |     2 |     0 |     0 |     0 |   2 |    24 |
| ACME   | 10-DEC-17 | 07-DEC-17 |  -        |     1 |     2 |     0 |     1 |     0 |   2 |    25 |
| ACME   | 11-DEC-17 | 07-DEC-17 | 11-DEC-17 |     1 |     2 |     0 |     1 |     1 |   2 |    19 |
| ACME   | 12-DEC-17 | 07-DEC-17 | 12-DEC-17 |     1 |     2 |     0 |     1 |     2 |   2 |    15 |
| ACME   | 16-DEC-17 | 16-DEC-17 |  -        |     1 |     0 |     0 |     0 |     0 |   3 |    12 |
| ACME   | 17-DEC-17 | 16-DEC-17 |  -        |     1 |     1 |     0 |     0 |     0 |   3 |    14 |
| ACME   | 18-DEC-17 | 16-DEC-17 |  -        |     1 |     2 |     0 |     0 |     0 |   3 |    24 |
| ACME   | 19-DEC-17 | 16-DEC-17 |  -        |     1 |     2 |     1 |     0 |     0 |   3 |    23 |
| ACME   | 20-DEC-17 | 16-DEC-17 | 20-DEC-17 |     1 |     2 |     1 |     0 |     1 |   3 |    22 |
+--------+-----------+-----------+-----------+-------+-------+-------+-------+-------+-----+-------+
(16 rows)

!ok

#match recoginize - /\/\/\ similar pattern detection
SELECT MR_ELLIOTT.*
FROM ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES
              COUNT(*) as CNT,
              COUNT(P.*) AS CNT_P,
              COUNT(Q.*) AS CNT_Q,
              COUNT(R.*) AS CNT_R,
              COUNT(S.*) AS CNT_S,
              COUNT(T.*) AS CNT_T,
              COUNT(U.*) AS CNT_U,
              CLASSIFIER() AS CLS,
     MATCH_NUMBER() AS MNO
     ALL ROWS PER MATCH
     AFTER MATCH SKIP TO LAST Z
     PATTERN (P Q+ R+ S+ T+ U+ V+ W+ X+ Y+ Z+)
     DEFINE
        Q AS Q.price > PREV(Q.price),
        R AS R.price < PREV(R.price),
        S AS S.price > PREV(S.price),
        T AS T.price < PREV(T.price),
        U AS U.price > PREV(U.price)
   ) MR_ELLIOTT
ORDER BY symbol, tstamp;
+--------+-----------+-----+-------+-------+-------+-------+-------+-------+-----+-----+-------+
| SYMBOL |  TSTAMP   | CNT | CNT_P | CNT_Q | CNT_R | CNT_S | CNT_T | CNT_U | CLS | MNO | PRICE |
+--------+-----------+-----+-------+-------+-------+-------+-------+-------+-----+-----+-------+
| ACME   | 01-DEC-17 |   1 |     1 |     0 |     0 |     0 |     0 |     0 | P   |   1 |    12 |
| ACME   | 02-DEC-17 |   2 |     1 |     1 |     0 |     0 |     0 |     0 | Q   |   1 |    17 |
| ACME   | 03-DEC-17 |   3 |     1 |     2 |     0 |     0 |     0 |     0 | Q   |   1 |    19 |
| ACME   | 04-DEC-17 |   4 |     1 |     3 |     0 |     0 |     0 |     0 | Q   |   1 |    21 |
| ACME   | 05-DEC-17 |   5 |     1 |     4 |     0 |     0 |     0 |     0 | Q   |   1 |    25 |
| ACME   | 06-DEC-17 |   6 |     1 |     4 |     1 |     0 |     0 |     0 | R   |   1 |    12 |
| ACME   | 07-DEC-17 |   7 |     1 |     4 |     1 |     1 |     0 |     0 | S   |   1 |    15 |
| ACME   | 08-DEC-17 |   8 |     1 |     4 |     1 |     2 |     0 |     0 | S   |   1 |    20 |
| ACME   | 09-DEC-17 |   9 |     1 |     4 |     1 |     3 |     0 |     0 | S   |   1 |    24 |
| ACME   | 10-DEC-17 |  10 |     1 |     4 |     1 |     4 |     0 |     0 | S   |   1 |    25 |
| ACME   | 11-DEC-17 |  11 |     1 |     4 |     1 |     4 |     1 |     0 | T   |   1 |    19 |
| ACME   | 12-DEC-17 |  12 |     1 |     4 |     1 |     4 |     2 |     0 | T   |   1 |    15 |
| ACME   | 13-DEC-17 |  13 |     1 |     4 |     1 |     4 |     2 |     1 | U   |   1 |    25 |
| ACME   | 14-DEC-17 |  14 |     1 |     4 |     1 |     4 |     2 |     1 | V   |   1 |    25 |
| ACME   | 15-DEC-17 |  15 |     1 |     4 |     1 |     4 |     2 |     1 | V   |   1 |    14 |
| ACME   | 16-DEC-17 |  16 |     1 |     4 |     1 |     4 |     2 |     1 | V   |   1 |    12 |
| ACME   | 17-DEC-17 |  17 |     1 |     4 |     1 |     4 |     2 |     1 | W   |   1 |    14 |
| ACME   | 18-DEC-17 |  18 |     1 |     4 |     1 |     4 |     2 |     1 | X   |   1 |    24 |
| ACME   | 19-DEC-17 |  19 |     1 |     4 |     1 |     4 |     2 |     1 | Y   |   1 |    23 |
| ACME   | 20-DEC-17 |  20 |     1 |     4 |     1 |     4 |     2 |     1 | Z   |   1 |    22 |
+--------+-----------+-----+-------+-------+-------+-------+-------+-------+-----+-----+-------+
(20 rows)

!ok

#match recognize - /\/\/\ one row match
SELECT MR_ELLIOTT.*
FROM ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES
              COUNT(*) as CNT,
              COUNT(P.*) AS CNT_P,
              COUNT(Q.*) AS CNT_Q,
              COUNT(R.*) AS CNT_R,
              COUNT(S.*) AS CNT_S,
              COUNT(T.*) AS CNT_T,
              COUNT(U.*) AS CNT_U,
              CLASSIFIER() AS CLS,
     MATCH_NUMBER() AS MNO
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST Z
     PATTERN (P Q+ R+ S+ T+ U+ V+ W{1,3} X+ Y+ Z+)
     DEFINE
        Q AS Q.price > PREV(Q.price),
        R AS R.price < PREV(R.price),
        S AS S.price > PREV(S.price),
        T AS T.price < PREV(T.price),
        U AS U.price > PREV(U.price)
   ) MR_ELLIOTT
ORDER BY symbol;
+--------+-----+-------+-------+-------+-------+-------+-------+-----+-----+
| SYMBOL | CNT | CNT_P | CNT_Q | CNT_R | CNT_S | CNT_T | CNT_U | CLS | MNO |
+--------+-----+-------+-------+-------+-------+-------+-------+-----+-----+
| ACME   |  20 |     1 |     4 |     1 |     4 |     2 |     1 | Z   |   1 |
+--------+-----+-------+-------+-------+-------+-------+-------+-----+-----+
(1 row)

!ok

#match recognize - cast in aggregation
SELECT M.Symbol, M.Tstamp, M.Price, M.RunningAvg, M.FinalAvg
FROM TICKER MATCH_RECOGNIZE (
     PARTITION BY Symbol
     ORDER BY tstamp
     MEASURES RUNNING AVG (CAST(A.Price AS Int)) AS RunningAvg,
              FINAL AVG (CAST(A.Price AS Int)) AS FinalAvg
     ALL ROWS PER MATCH
     PATTERN (A+)
     DEFINE A AS A.Price >= AVG (A.Price)
     ) M
;
+--------+-----------+-------+-------------------------------------------+-------------------------------------------+
| SYMBOL |  TSTAMP   | PRICE |                RUNNINGAVG                 |                 FINALAVG                  |
+--------+-----------+-------+-------------------------------------------+-------------------------------------------+
| ACME   | 01-DEC-17 |    12 |                                        12 |                                      18.8 |
| ACME   | 01-DEC-17 |    12 |                                        12 |                                      18.8 |
| ACME   | 02-DEC-17 |    17 | 13.66666666666666666666666666666666666667 |                                      18.8 |
| ACME   | 02-DEC-17 |    17 |                                      14.5 |                                      18.8 |
| ACME   | 03-DEC-17 |    19 |                                      15.4 |                                      18.8 |
| ACME   | 03-DEC-17 |    19 |                                        16 |                                      18.8 |
| ACME   | 04-DEC-17 |    21 | 16.71428571428571428571428571428571428571 |                                      18.8 |
| ACME   | 04-DEC-17 |    21 |                                     17.25 |                                      18.8 |
| ACME   | 05-DEC-17 |    25 | 18.11111111111111111111111111111111111111 |                                      18.8 |
| ACME   | 05-DEC-17 |    25 |                                      18.8 |                                      18.8 |
| ACME   | 06-DEC-17 |    12 |                                        12 |                                      19.2 |
| ACME   | 06-DEC-17 |    12 |                                        12 |                                      19.2 |
| ACME   | 07-DEC-17 |    15 |                                        13 |                                      19.2 |
| ACME   | 07-DEC-17 |    15 |                                      13.5 |                                      19.2 |
| ACME   | 08-DEC-17 |    20 |                                      14.8 |                                      19.2 |
| ACME   | 08-DEC-17 |    20 | 15.66666666666666666666666666666666666667 |                                      19.2 |
| ACME   | 09-DEC-17 |    24 | 16.85714285714285714285714285714285714286 |                                      19.2 |
| ACME   | 09-DEC-17 |    24 |                                     17.75 |                                      19.2 |
| ACME   | 10-DEC-17 |    25 | 18.55555555555555555555555555555555555556 |                                      19.2 |
| ACME   | 10-DEC-17 |    25 |                                      19.2 |                                      19.2 |
| ACME   | 11-DEC-17 |    19 |                                        19 |                                        19 |
| ACME   | 11-DEC-17 |    19 |                                        19 |                                        19 |
| ACME   | 12-DEC-17 |    15 |                                        15 | 21.66666666666666666666666666666666666667 |
| ACME   | 12-DEC-17 |    15 |                                        15 | 21.66666666666666666666666666666666666667 |
| ACME   | 13-DEC-17 |    25 | 18.33333333333333333333333333333333333333 | 21.66666666666666666666666666666666666667 |
| ACME   | 13-DEC-17 |    25 |                                        20 | 21.66666666666666666666666666666666666667 |
| ACME   | 14-DEC-17 |    25 |                                        21 | 21.66666666666666666666666666666666666667 |
| ACME   | 14-DEC-17 |    25 | 21.66666666666666666666666666666666666667 | 21.66666666666666666666666666666666666667 |
| ACME   | 15-DEC-17 |    14 |                                        14 |                                        14 |
| ACME   | 15-DEC-17 |    14 |                                        14 |                                        14 |
| ACME   | 16-DEC-17 |    12 |                                        12 |                                        19 |
| ACME   | 16-DEC-17 |    12 |                                        12 |                                        19 |
| ACME   | 17-DEC-17 |    14 | 12.66666666666666666666666666666666666667 |                                        19 |
| ACME   | 17-DEC-17 |    14 |                                        13 |                                        19 |
| ACME   | 18-DEC-17 |    24 |                                      15.2 |                                        19 |
| ACME   | 18-DEC-17 |    24 | 16.66666666666666666666666666666666666667 |                                        19 |
| ACME   | 19-DEC-17 |    23 | 17.57142857142857142857142857142857142857 |                                        19 |
| ACME   | 19-DEC-17 |    23 |                                     18.25 |                                        19 |
| ACME   | 20-DEC-17 |    22 | 18.66666666666666666666666666666666666667 |                                        19 |
| ACME   | 20-DEC-17 |    22 |                                        19 |                                        19 |
+--------+-----------+-------+-------------------------------------------+-------------------------------------------+
(40 rows)

!ok

#match recognize - max expression in aggregation
SELECT M.Symbol,  M.RunningAvg, M.FinalAvg
FROM TICKER MATCH_RECOGNIZE (
     PARTITION BY Symbol
     ORDER BY tstamp
     MEASURES RUNNING AVG (A.Price) AS RunningAvg,
              FINAL AVG (A.Price) AS FinalAvg
     ONE ROW PER MATCH
     PATTERN (A+)
     DEFINE A AS A.Price = MAX (A.Price)
     ) M
;
+--------+-------------------------------------------+-------------------------------------------+
| SYMBOL |                RUNNINGAVG                 |                 FINALAVG                  |
+--------+-------------------------------------------+-------------------------------------------+
| ACME   |                                      18.8 |                                      18.8 |
| ACME   |                                      19.2 |                                      19.2 |
| ACME   |                                        19 |                                        19 |
| ACME   | 21.66666666666666666666666666666666666667 | 21.66666666666666666666666666666666666667 |
| ACME   |                                        14 |                                        14 |
| ACME   | 16.66666666666666666666666666666666666667 | 16.66666666666666666666666666666666666667 |
| ACME   |                                        23 |                                        23 |
| ACME   |                                        22 |                                        22 |
+--------+-------------------------------------------+-------------------------------------------+
(8 rows)

!ok


#match recognize - ORA-62505: expression needs to be aliased
SELECT *
FROM Ticker MATCH_RECOGNIZE(
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES FIRST(STRT.tstamp) ,
              LAST(DOWN.tstamp) AS bottom,
              AVG(STDN.Price) AS stdn_avgprice
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST UP
     PATTERN (STRT DOWN+ UP+)
     SUBSET STDN= (STRT, DOWN)
     DEFINE
        UP AS UP.Price > PREV(UP.Price),
        DOWN AS DOWN.Price < PREV (DOWN.Price)
);

!error

#match recognize - ORA-62512: This aggregate is not yet supported in MATCH_RECOGNIZE clause.
SELECT *
FROM Ticker MATCH_RECOGNIZE(
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES FIRST(STRT.tstamp) AS strt_time,
              LAST(DOWN.tstamp) AS bottom,
              MEDIAN(STDN.Price) AS stdn_avgprice
     AFTER MATCH SKIP TO FIRST DOWN
     PATTERN (STRT DOWN+ UP+)
     SUBSET STDN= (STRT, DOWN)
     DEFINE
        UP AS UP.Price > PREV(UP.Price),
        DOWN AS DOWN.Price < PREV (DOWN.Price)
);

!error

#match recognize - ORA-30483: window functions are not allowed here
SELECT *
FROM Ticker MATCH_RECOGNIZE(
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES FIRST(STRT.tstamp) AS strt_time,
              LAST(DOWN.tstamp) AS bottom,
              CAST(AVG(STDN.Price) AS INTEGER) AS stdn_avgprice,
              FIRST_VALUE(STDN.Price) over(partition by symbol) as first_price
     AFTER MATCH SKIP TO FIRST UP
     PATTERN (STRT DOWN+ UP+)
     SUBSET STDN= (STRT, DOWN)
     DEFINE
        UP AS UP.Price > PREV(UP.Price),
        DOWN AS DOWN.Price < PREV (DOWN.Price)
);

!error

#match recognize - ORA-62517: Next match starts at the same point last match started.
SELECT *
FROM Ticker MATCH_RECOGNIZE (
     PARTITION BY symbol
     ORDER BY tstamp
     MEASURES  PRESTRT.tstamp as prestart_tstamp,
               STRT.tstamp AS start_tstamp,
               LAST(DOWN.tstamp) AS bottom_tstamp,
               LAST(UP.tstamp) AS end_tstamp
     ONE ROW PER MATCH
     AFTER MATCH SKIP TO LAST PRESTRT
     PATTERN (PRESTRT STRT DOWN+ UP+)
     DEFINE
        STRT AS STRT.tstamp > PRESTRT.tstamp,
        DOWN AS DOWN.price < PREV(DOWN.price),
        UP AS UP.price > PREV(UP.price)
     ) MR
ORDER BY MR.symbol, MR.start_tstamp;

!error

#match recognize - ORA-00907: missing right parenthesis
SELECT M.Symbol, M.Tstamp, M.Price, M.RunningAvg, M.FinalAvg
FROM TICKER MATCH_RECOGNIZE (
     PARTITION BY Symbol
     ORDER BY tstamp
     MEASURES RUNNING CAST(AVG (A.Price) as Int) AS RunningAvg,
              FINAL CAST(AVG (A.Price) as Int) AS FinalAvg
     ALL ROWS PER MATCH
     PATTERN (A+)
     DEFINE A AS A.Price >= AVG (A.Price)
     ) M
;

!error

# End match.iq
